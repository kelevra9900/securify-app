import {useCallback,useEffect} from 'react';
import {Alert} from 'react-native';
import {useNavigation} from '@react-navigation/native'; \nimport * as Sentry from '@sentry/react-native'; \nimport {addAppBreadcrumb} from '@/conf/sentry.conf'; \nimport {showSuccessToast,showErrorToast} from '@/utils/toast'; \nimport {useEndRound} from '@/hooks/rounds'; \nimport {useAndroidUserTracking} from '@/hooks/useAndroidUserTracking'; \n\ninterface UseRoundCompletionProps {\n  roundId ?: number; \n  roundName ?: string; \n  isCompleted: boolean; \n  completionPercentage: number; \n} \n\n/**\n * Hook para manejar la finalizaci칩n de rondas\n * \n * Proporciona funcionalidades para:\n * - Terminar ronda manualmente\n * - Detener tracking autom치ticamente\n * - Manejar diferentes escenarios (completa vs incompleta)\n * - Navegaci칩n despu칠s de finalizar\n * \n * @example\n * ```tsx\n * const {\n *   handleEndRound,\n *   showEndRoundDialog,\n *   isEndingRound\n * } = useRoundCompletion({\n *   roundId,\n *   roundName,\n *   isCompleted: progress >= 100,\n *   completionPercentage: progress\n * });\n * ```\n */\nexport function useRoundCompletion({\n  roundId,\n  roundName,\n  isCompleted,\n  completionPercentage,\n}: UseRoundCompletionProps) {\n  const {isPending: isEndingRound,mutateAsync: endRound} = useEndRound(); \n  const navigation = useNavigation(); \n  \n  // Hook de tracking Android\n  const {\n    isTrackingActive,\n    stopPatrolTracking,\n  } = useAndroidUserTracking();\n\n  // Funci칩n principal para terminar la ronda\n  const handleEndRound = useCallback(async (notes?: string) => {\n    if (!roundId) {\n      showErrorToast('No hay ronda activa para terminar');\n      return false;\n    }\n\n    try {\n      addAppBreadcrumb({\n        category: 'rounds.end',\n        data: { \n          roundId, \n          roundName,\n          completionPercentage,\n          hasNotes: !!notes,\n          wasTracking: isTrackingActive\n        },\n        message: 'Iniciando finalizaci칩n de ronda',\n      });\n\n      // 1. Terminar la ronda en el backend\n      await endRound({ roundId, notes });\n      \n      // 2. Detener tracking si est치 activo\n      if (isTrackingActive) {\n        stopPatrolTracking();\n        addAppBreadcrumb({\n          category: 'tracking.stop',\n          data: { reason: 'round_ended', roundId },\n          message: 'Tracking detenido autom치ticamente por fin de ronda',\n        });\n      }\n\n      // 3. Mostrar confirmaci칩n\n      const message = isCompleted \n        ? `Ronda \"${roundName}\" finalizada exitosamente`\n        : `Ronda \"${roundName}\" terminada (${completionPercentage}% completada)`;\n      \n      showSuccessToast(message);\n      \n      // 4. Navegar de vuelta\n      navigation.goBack();\n      \n      return true;\n      \n    } catch (error) {\n      console.error('[useRoundCompletion] Error terminando ronda:', error);\n      \n      const errorMessage = error instanceof Error \n        ? error.message \n        : 'Error desconocido al terminar la ronda';\n      \n      showErrorToast(`Error: ${errorMessage}`);\n      \n      Sentry.captureException(error, {\n        tags: { \n          feature: 'rounds', \n          action: 'end',\n          completion: isCompleted ? 'complete' : 'incomplete'\n        },\n        extra: { \n          roundId, \n          roundName,\n          completionPercentage,\n          notes,\n          isTrackingActive\n        }\n      });\n      \n      return false;\n    }\n  }, [roundId, roundName, completionPercentage, isCompleted, isTrackingActive, endRound, stopPatrolTracking, navigation]);\n\n  // Funci칩n para mostrar di치logo de confirmaci칩n\n  const showEndRoundDialog = useCallback(() => {\n    if (isEndingRound) return; // Prevenir m칰ltiples di치logos\n    \n    const title = 'Finalizar Ronda';\n    const message = isCompleted \n      ? `La ronda \"${roundName}\" est치 completa (${completionPercentage}%). 쮻eseas finalizarla?`\n      : `La ronda \"${roundName}\" no est치 completa (${completionPercentage}%). 쮻eseas terminarla de todas formas?`;\n\n    Alert.alert(\n      title,\n      message,\n      [\n        {\n          text: 'Cancelar',\n          style: 'cancel'\n        },\n        {\n          text: 'Agregar Notas',\n          onPress: () => {\n            Alert.prompt(\n              'Notas de Finalizaci칩n',\n              'Agrega notas opcionales sobre esta ronda:',\n              [\n                { text: 'Cancelar', style: 'cancel' },\n                {\n                  text: 'Finalizar con Notas',\n                  onPress: (notes) => handleEndRound(notes?.trim() || undefined)\n                }\n              ],\n              'plain-text',\n              '',\n              'default'\n            );\n          }\n        },\n        {\n          text: isCompleted ? 'Finalizar' : 'Terminar Ahora',\n          onPress: () => handleEndRound(),\n          style: isCompleted ? 'default' : 'destructive'\n        }\n      ]\n    );\n  }, [isEndingRound, isCompleted, roundName, completionPercentage, handleEndRound]);\n\n  // Funci칩n r치pida para finalizar sin notas\n  const quickEndRound = useCallback(() => {\n    handleEndRound();\n  }, [handleEndRound]);\n\n  // Auto-finalizar cuando se completa al 100% (opcional)\n  const autoFinishWhenComplete = useCallback(() => {\n    if (isCompleted && completionPercentage >= 100) {\n      Alert.alert(\n        '游꿀 Ronda Completa',\n        `춰Has completado la ronda \"${roundName}\"! 쮻eseas finalizarla autom치ticamente?`,\n        [\n          {\n            text: 'Continuar',\n            style: 'cancel'\n          },\n          {\n            text: 'Finalizar Ahora',\n            onPress: quickEndRound\n          }\n        ]\n      );\n    }\n  }, [isCompleted, completionPercentage, roundName, quickEndRound]);\n\n  return {\n    // Estado\n    isEndingRound,\n    canEnd: !!roundId,\n    \n    // Funciones principales\n    handleEndRound,\n    showEndRoundDialog,\n    quickEndRound,\n    autoFinishWhenComplete,\n    \n    // Estado de tracking\n    isTrackingActive,\n    willStopTracking: isTrackingActive, // Indica si se detendr치 el tracking\n  };\n}"

